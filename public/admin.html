<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .delete-btn {
            background-color: #ff4d4d; 
            padding: 5px 10px; 
            color: white; 
            border-radius: 5px; 
            text-decoration: none; 
            cursor: pointer;
            border: none;
            font-size: 12px;
        }
        .delete-btn:hover { background-color: #cc0000; }
        .fee-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üõ°Ô∏è Admin Dashboard</h2>
            <button onclick="logout()">Logout</button>
        </div>

        <div class="card">
            <h3>‚ûï Manage Fee Types</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-fee-name" placeholder="Fee Name (e.g. Lab Fee)">
                <input type="number" id="new-fee-amount" placeholder="Amount">
            </div>
            <button onclick="addFee()">Add Fee</button>
            
            <div id="fee-list" style="margin-top: 20px; text-align: left;">
                </div>
        </div>

        <div class="card">
            <h3>üìú Transaction History</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Fee Type</th>
                            <th>Amount</th>
                            <th>Receipt</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tx-table"></tbody>
                </table>
            </div>
        </div>

        <div class="chat-container">
            <h3>ü§ñ Admin Assistant</h3>
            <div id="chat-box"></div>
            <input type="text" id="bot-input" placeholder="Ask me something...">
            <button onclick="sendMsg()">Ask AI</button>
        </div>
    </div>

    <script>
        // Load Everything on Start
        loadFees();
        loadPayments();

        async function loadFees() {
            const res = await fetch('/api/fees');
            const data = await res.json();
            const list = document.getElementById('fee-list');
            list.innerHTML = '<h4>Current Active Fees:</h4>';
            
            data.forEach(fee => {
                list.innerHTML += `
                    <div class="fee-item">
                        <span>${fee.FeeName} - ‚Çπ${fee.Amount}</span>
                        <button class="delete-btn" onclick="deleteFee(${fee.FeeID})">Remove</button>
                    </div>
                `;
            });
        }

        async function loadPayments() {
            const res = await fetch('/api/admin/payments');
            const data = await res.json();
            const tbody = document.getElementById('tx-table');
            tbody.innerHTML = '';
            data.forEach(tx => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(tx.PaymentDate).toLocaleDateString()}</td>
                        <td>${tx.FeeName}</td>
                        <td>‚Çπ${tx.Amount}</td>
                        <td><a href="${tx.ReceiptURL}" target="_blank" style="color:#0078D7; font-weight:bold;">View</a></td>
                        <td><button class="delete-btn" onclick="deletePayment(${tx.PaymentID})">Delete</button></td>
                    </tr>
                `;
            });
        }

        async function addFee() {
            const name = document.getElementById('new-fee-name').value;
            const amount = document.getElementById('new-fee-amount').value;
            await fetch('/api/admin/add-fee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feeName: name, amount })
            });
            alert('Fee Added!');
            loadFees(); // Refresh list
        }

        async function deleteFee(id) {
            if(!confirm("Delete this fee type?")) return;
            await fetch(`/api/admin/delete-fee/${id}`, { method: 'DELETE' });
            loadFees();
        }

        async function deletePayment(id) {
            if(!confirm("Delete this transaction record?")) return;
            await fetch(`/api/admin/delete-payment/${id}`, { method: 'DELETE' });
            loadPayments();
        }

        async function sendMsg() {
            const text = document.getElementById('bot-input').value;
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            document.getElementById('chat-box').innerHTML += `<div><b>Admin:</b> ${text}</div><div style="color:#667eea"><b>Bot:</b> ${data.response}</div>`;
            document.getElementById('bot-input').value = "";
        }

        function logout() { localStorage.clear(); window.location.href = 'portal.html'; }
    </script>
</body>
</html>