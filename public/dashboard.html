<!DOCTYPE html>
<html lang="en">
<head>
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <div class="dashboard">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ðŸŽ“ Student Dashboard</h2>
            <button onclick="logout()">Logout</button>
        </div>

        <div class="card">
            <h3>ðŸ’³ Pay Fees</h3>
            <select id="fee-select">
                <option value="">Loading fees...</option>
            </select>
            <button id="pay-btn">Pay Now</button>
            
            <div id="receipt-area" style="margin-top:20px; display:none; background:#e8f5e9; padding:15px; border-radius:10px; color:green;">
                <p>âœ… Payment Successful!</p>
                <a id="receipt-link" href="#" target="_blank" style="font-weight:bold; color:#2ecc71;">Download Your Receipt</a>
            </div>
        </div>

        <div class="chat-container">
            <h3>ðŸ¤– AI Support Bot</h3>
            <div id="chat-box"></div>
            <input type="text" id="bot-input" placeholder="Ask me anything...">
            <button onclick="sendMsg()">Ask</button>
        </div>
    </div>

    <script>
        let selectedFeeName = "";
        let selectedAmount = 0;

        async function loadFees() {
            const res = await fetch('/api/fees');
            const data = await res.json();
            const select = document.getElementById('fee-select');
            select.innerHTML = '';
            data.forEach(fee => {
                const opt = document.createElement('option');
                opt.value = fee.Amount;
                opt.text = `${fee.FeeName} - â‚¹${fee.Amount}`;
                opt.setAttribute('data-name', fee.FeeName);
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                selectedAmount = e.target.value;
                selectedFeeName = e.target.options[e.target.selectedIndex].getAttribute('data-name');
            });
            if(data.length > 0) {
                selectedAmount = data[0].Amount;
                selectedFeeName = data[0].FeeName;
            }
        }

        document.getElementById('pay-btn').addEventListener('click', async () => {
            const res = await fetch('/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: selectedAmount })
            });
            const order = await res.json();
            
            const options = {
                "key": "YOUR_TEST_KEY_ID_HERE", // REPLACE WITH YOUR KEY
                "amount": order.amount,
                "currency": "INR",
                "order_id": order.id,
                "handler": async function (response) {
                    document.getElementById('pay-btn').innerText = "Generating Receipt...";
                    
                    // Send to backend to Auto-Generate Receipt
                    const recRes = await fetch('/api/record-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            feeName: selectedFeeName, 
                            amount: selectedAmount,
                            paymentId: response.razorpay_payment_id
                        })
                    });
                    const recData = await recRes.json();
                    
                    if(recData.success) {
                        document.getElementById('receipt-area').style.display = 'block';
                        document.getElementById('receipt-link').href = recData.receiptUrl;
                        document.getElementById('pay-btn').innerText = "Pay Now";
                        alert("Payment Successful! Receipt Generated.");
                    }
                }
            };
            new Razorpay(options).open();
        });

        async function sendMsg() {
            const text = document.getElementById('bot-input').value;
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            document.getElementById('chat-box').innerHTML += `<div><b>You:</b> ${text}</div><div style="color:#667eea"><b>Bot:</b> ${data.response}</div>`;
            document.getElementById('bot-input').value = "";
        }

        function logout() { localStorage.clear(); window.location.href = 'portal.html'; }
        
        loadFees();
    </script>
</body>
</html>